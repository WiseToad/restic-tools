#!/usr/bin/env bash

HOME_DIR="$(cd "$(dirname "$(readlink -f "$0")")/.." && pwd)"
REPO_DIR="${HOME_DIR}/config/repository"

main()
{
    local repo="$1"
    shift

    if [ -z "${repo}" ]; then
        die "No restic repository specified"
    fi

    # Load config
    local conf_file="${HOME_DIR}/config/restic-tools.conf"
    if [ -f "${conf_file}" ]; then
        source "${conf_file}"
    fi

    # Load restic env
    local env_file="${HOME_DIR}/config/restic.env"
    if [ -f "${env_file}" ]; then
        load_env "${env_file}"
    fi

    # Load specific repo env
    load_repo_env "${repo}"

    "${RESTIC}" "$@"
}

load_repo_env()
{
    local repo="$1"

    local repo_dir="${REPO_DIR}/${repo}"
    if [ ! -d "${repo_dir}" ]; then
        die "No such repository found: ${repo}"
    fi

    for env_file in "${repo_dir}"/*.env; do
        if [ -f "$env_file" ]; then
            load_env "${env_file}"
        fi
    done
}

load_env()
{
    local env_file="$1"

    set -a
    source "${env_file}" || die
    set +a
}

log()
{
    echo "$@" >&2
}

die()
{
    [ $# -ge 1 ] && log "$@"
    exit 1
}

main "$@"
