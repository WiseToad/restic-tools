#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"

source "${SCRIPT_DIR}/restic-tools"

main()
{
    local repo="$1"
    [ $# -gt 0 ] && shift

    if [ -z "${repo}" ]; then
        die "No restic repository specified"
    fi

    local config_dir
    config_dir=$(get_config_dir) || die

    # Load restic env
    local env_file="${config_dir}/restic.env"
    if [ -f "${env_file}" ]; then
        load_env "${env_file}"
    fi

    # Load specific repo env
    REPO_DIR="${config_dir}/repository/${repo}"
    if [ ! -d "${REPO_DIR}" ]; then
        die "No such repository found: ${repo}"
    fi
    for env_file in "${REPO_DIR}"/*.env; do
        if [ -f "$env_file" ]; then
            load_env "${env_file}"
        fi
    done

    restic "$@"
}

load_env()
{
    local env_file="$1"

    set -a
    source "${env_file}" || die
    set +a
}

main "$@"
