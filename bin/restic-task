#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"

source "${SCRIPT_DIR}/restic-tools"

main()
{
    local task="$1"
    local domain="$2"

    if [ -z "${task}" ]; then
        die "No task specified"
    fi
    if [ -z "${domain}" ]; then
        die "No domain specified"
    fi

    local config_dir
    config_dir=$(get_config_dir) || die

    local task_dir="${config_dir}/task/${domain}"
    if [ ! -d "${task_dir}" ]; then
        die "No such domain found: ${domain}"
    fi

    local task_file="${task_dir}/${task}"
    if [ ! -f "${task_file}" ]; then
        die "No task ${task} found for domain ${domain}"
    fi

    cd "${task_dir}" || die

    local success_file
    success_file="$(mktemp -t success.XXXXXXXXXX)" || die
    export success_file

    export -f log die fail

    log "Starting ${task} for ${domain}"
    bash "${task}" "$@" || fail

    if [ ! -e "${success_file}" ]; then
        die "Task failed"
    fi

    rm "${success_file}"
    log "Task finished"
}

fail()
{
    [ $# -ge 1 ] && log "$@"
    rm -f "${success_file}"
}

main "$@"
